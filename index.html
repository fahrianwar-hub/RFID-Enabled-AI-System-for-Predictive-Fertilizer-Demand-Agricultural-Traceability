<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - RFID + AI (MVP) — Bone + Blockchain</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- CryptoJS (SHA-256) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    #map { height: 300px; }
    .card { background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    body { background: #f3f4f6; }
    .kpi { font-weight: 700; font-size: 1.25rem; }
    .muted { color: #6b7280; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
    .danger { background: #fee2e2 !important; }
    .pointer { cursor: pointer; }
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center}
    .modal{background:white;padding:1rem;border-radius:0.5rem;min-width:320px;max-width:720px}
  </style>
</head>
<body class="p-6 font-sans text-slate-800">
  <header class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold">RFID → AI Dashboard (MVP) — Bone + Blockchain</h1>
        <p class="muted">Traceability Distributor → Toko → Petani — demo prototype</p>
      </div>
      <div class="flex gap-3 items-center">
        <div class="muted text-sm">Data sample: dummy</div>
        <button id="exportCsv" class="px-3 py-2 bg-sky-600 text-white rounded">Export CSV</button>
      </div>
    </div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Filters & KPIs -->
    <section class="lg:col-span-1 space-y-4">
      <div class="card">
        <h2 class="text-lg font-medium">Filter</h2>
        <div class="mt-3 space-y-3">
          <label class="block text-sm">Periode</label>
          <select id="periodSelect" class="w-full border rounded p-2">
            <option value="last30">30 hari terakhir</option>
            <option value="last90">90 hari terakhir</option>
            <option value="last180">180 hari terakhir</option>
            <option value="ytd">Tahun berjalan</option>
            <option value="all">Semua</option>
          </select>

          <label class="block text-sm">Komoditas</label>
          <select id="commoditySelect" class="w-full border rounded p-2">
            <option value="all">Semua</option>
            <option value="padi">Padi</option>
            <option value="jagung">Jagung</option>
            <option value="sayur">Sayur</option>
          </select>

          <label class="block text-sm">Kecamatan</label>
          <select id="locationSelect" class="w-full border rounded p-2">
            <option value="all">Semua</option>
            <option value="tanete riattang">Tanete Riattang</option>
            <option value="barebbo">Barebbo</option>
            <option value="awangpone">Awangpone</option>
            <option value="dua boccoe">Dua Boccoe</option>
            <option value="cenrana">Cenrana</option>
            <option value="tellu siattinge">Tellu Siattinge</option>
            <option value="mare">Mare</option>
            <option value="sibulue">Sibulue</option>
            <option value="kahu">Kahu</option>
          </select>

          <button id="applyFilters" class="w-full mt-2 bg-emerald-600 text-white py-2 rounded">Terapkan</button>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-medium">KPI Utama</h2>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div class="p-3 border rounded">
            <div class="muted text-sm">Prediksi Kebutuhan Pupuk (kg)</div>
            <div class="kpi" id="kpiFertilizer">—</div>
          </div>
          <div class="p-3 border rounded">
            <div class="muted text-sm">Jumlah Tag RFID Terbaca</div>
            <div class="kpi" id="kpiTags">—</div>
          </div>
          <div class="p-3 border rounded">
            <div class="muted text-sm">Lahan Aktif</div>
            <div class="kpi" id="kpiFields">—</div>
          </div>
          <div class="p-3 border rounded">
            <div class="muted text-sm">Performa Akurasi Model</div>
            <div class="kpi" id="kpiAcc">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="text-lg font-medium">Traceability Quick View</h2>
        <div class="mt-3 text-sm muted">Klik baris pada tabel RFID untuk detail singkat.</div>
      </div>
    </section>

    <!-- Charts + Table -->
    <section class="lg:col-span-2 space-y-4">
      <div class="card">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-medium">Prediksi Kebutuhan Pupuk — Trend</h2>
          <div class="muted text-sm">Regression + Time-series (demo)</div>
        </div>
        <canvas id="fertChart" class="mt-4"></canvas>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-medium">Distribusi Pupuk per Kecamatan</h3>
          <canvas id="distChart" class="mt-3"></canvas>
        </div>
        <div class="card">
          <h3 class="font-medium">Peta Lokasi Lahan</h3>
          <div id="map" class="mt-3"></div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-medium">Catatan Pembacaan RFID (Terakhir)</h3>
        <div class="mt-3 overflow-x-auto">
          <table id="rfidTable">
            <thead>
              <tr>
                <th>Waktu</th><th>Tag ID</th><th>Komoditas</th><th>Lahan</th><th>Pupuk (kg)</th><th>Status</th>
              </tr>
            </thead>
            <tbody><!-- filled by JS --></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Blockchain -->
    <section class="lg:col-span-3 mt-6">
      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-medium">Blockchain Supply Chain Tracking</h2>
            <p class="muted text-sm mt-1">Distributor → Toko → Petani</p>
          </div>
          <div class="flex gap-2">
            <button id="btnVerify" class="px-3 py-2 bg-yellow-500 rounded text-white">Verify Chain</button>
            <button id="btnRegenerate" class="px-3 py-2 bg-sky-600 rounded text-white">Regenerate Chain</button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table id="blockchainTable">
            <thead>
              <tr>
                <th>Index</th><th>Hash</th><th>PrevHash</th><th>Tag RFID</th><th>Distributor</th><th>Toko</th><th>Waktu</th><th>Status</th>
              </tr>
            </thead>
            <tbody><!-- filled by JS --></tbody>
          </table>
        </div>

        <div class="mt-3 muted text-sm">Klik baris blockchain untuk melihat jalur supply chain (modal).</div>
      </div>
    </section>
  </main>

  <footer class="mt-6 muted text-sm">MVP Dashboard — prototype.</footer>

  <!-- Modal -->
  <div id="modal" class="modal-bg"><div class="modal"><div id="modalContent"></div><div class="mt-3 text-right"><button id="modalClose" class="px-3 py-1 bg-gray-200 rounded">Tutup</button></div></div></div>

<script>
/* ---------- Data ---------- */
const dummyReadings = [
  {time:'2025-11-01 08:15', tag:'RFID-BONE-001', commodity:'padi', field:'Tanete Riattang - Lahan 1', fert:14, status:'OK', lat:-4.5296, lon:120.3330},
  {time:'2025-11-03 09:40', tag:'RFID-BONE-002', commodity:'jagung', field:'Barebbo - Lahan 3', fert:9, status:'OK', lat:-4.5475, lon:120.2602},
  {time:'2025-11-05 06:20', tag:'RFID-BONE-003', commodity:'sayur', field:'Awangpone - Lahan 2', fert:6, status:'OK', lat:-4.6020, lon:120.2501},
  {time:'2025-11-07 10:05', tag:'RFID-BONE-004', commodity:'padi', field:'Tanete Riattang Timur - Lahan 4', fert:12, status:'OK', lat:-4.5325, lon:120.3500},
  {time:'2025-11-10 07:50', tag:'RFID-BONE-005', commodity:'padi', field:'Dua Boccoe - Lahan 5', fert:17, status:'OK', lat:-4.4360, lon:120.3335},
  {time:'2025-11-12 09:33', tag:'RFID-BONE-006', commodity:'jagung', field:'Cenrana - Lahan 6', fert:10, status:'OK', lat:-4.3840, lon:120.1950},
  {time:'2025-11-14 08:15', tag:'RFID-BONE-007', commodity:'sayur', field:'Tellu Siattinge - Lahan 3', fert:5, status:'OK', lat:-4.4642, lon:120.1560},
  {time:'2025-11-16 11:40', tag:'RFID-BONE-008', commodity:'padi', field:'Mare - Lahan A7', fert:13, status:'OK', lat:-4.6750, lon:120.2400},
  {time:'2025-11-18 07:55', tag:'RFID-BONE-009', commodity:'padi', field:'Sibulue - Lahan B2', fert:19, status:'OK', lat:-4.5498, lon:120.4502},
  {time:'2025-11-20 06:30', tag:'RFID-BONE-010', commodity:'sayur', field:'Kahu - Lahan 9', fert:7, status:'OK', lat:-4.7700, lon:120.1800}
];

let blockchainLog = [
  {tag:'RFID-BONE-001', distributor:'Distributor Makassar 01', store:'Toko Tani Bone', time:'2025-10-30 14:22'},
  {tag:'RFID-BONE-002', distributor:'Distributor Bone 02', store:'UD Sumber Makmur', time:'2025-11-01 10:11'},
  {tag:'RFID-BONE-003', distributor:'Distributor Makassar 03', store:'Toko Karya Bone', time:'2025-11-02 09:05'},
  {tag:'RFID-BONE-004', distributor:'Distributor Parepare 07', store:'CV Maju Bersama', time:'2025-11-04 15:27'},
  {tag:'RFID-BONE-005', distributor:'Distributor Bone Tengah', store:'Toko Pangan Jaya', time:'2025-11-06 08:33'}
];

/* ---------- Hash utility (CryptoJS preferred) ---------- */
function sha256(str){
  if(window.CryptoJS && CryptoJS.SHA256){
    try{ return CryptoJS.SHA256(str).toString(); }catch(e){ console.warn('CryptoJS error', e); }
  }
  // fallback non-crypto demo
  let h = 2166136261 >>> 0;
  for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619) >>> 0; }
  return ('00000000'+(h>>>0).toString(16)).slice(-8);
}

/* ---------- Blockchain chain builder ---------- */
let blockchainChain = [];
function generateBlockchainChain(){
  blockchainChain = [];
  let prevHash = "0x000000";
  blockchainLog.forEach((entry, index)=>{
    const blockData = `${entry.tag}|${entry.distributor}|${entry.store}|${entry.time}|${prevHash}`;
    const hash = sha256(blockData);
    blockchainChain.push({index:index+1, tag:entry.tag, distributor:entry.distributor, store:entry.store, time:entry.time, prevHash:prevHash, hash:hash});
    prevHash = hash;
  });
}

/* ---------- Render helpers ---------- */
function renderTable(data){
  try{
    const tbody = document.querySelector('#rfidTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    data.forEach(r =>{
      const tr = document.createElement('tr');
      tr.classList.add('pointer');
      tr.innerHTML = `<td>${r.time}</td><td>${r.tag}</td><td>${r.commodity}</td><td>${r.field}</td><td>${r.fert}</td><td>${r.status}</td>`;
      tr.addEventListener('click', ()=>{ showModal(`<h3>Trace RFID ${r.tag}</h3><p>Lahan: ${r.field}<br/>Komoditas: ${r.commodity}<br/>Pupuk: ${r.fert} kg</p>`); });
      tbody.appendChild(tr);
    });
  }catch(e){ console.error('renderTable error', e); }
}

function renderBlockchain(){
  try{
    const tbody = document.querySelector('#blockchainTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    if(!blockchainChain || blockchainChain.length===0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="8" class="muted">(Blockchain kosong — klik Regenerate Chain)</td>`;
      tbody.appendChild(tr);
      return;
    }
    blockchainChain.forEach(b =>{
      const tr = document.createElement('tr');
      tr.setAttribute('data-index', b.index);
      tr.innerHTML = `<td>${b.index}</td><td style="font-family:monospace;word-break:break-all;">${b.hash}</td><td style="font-family:monospace;word-break:break-all;">${b.prevHash}</td><td>${b.tag}</td><td>${b.distributor}</td><td>${b.store}</td><td>${b.time}</td><td class="status">OK</td>`;
      tr.addEventListener('click', ()=> onBlockchainRowClick(b));
      tbody.appendChild(tr);
    });
  }catch(e){ console.error('renderBlockchain error', e); }
}

function onBlockchainRowClick(block){
  const trace = blockchainChain.filter(b=>b.tag===block.tag).map(b=>`${b.index}. ${b.distributor} → ${b.store} @ ${b.time}`).join('<br/>');
  showModal(`<h3>Trace ${block.tag}</h3><p>${trace || 'Tidak ditemukan jejak lengkap pada chain.'}</p>`);
}

function showModal(html){ const modal = document.getElementById('modal'); const content = document.getElementById('modalContent'); content.innerHTML = html; modal.style.display = 'flex'; }
function hideModal(){ document.getElementById('modal').style.display = 'none'; }

/* ---------- Charts & Map ---------- */
let fertChart=null, distChart=null, mapInstance=null, mapMarkers=[];
function initCharts(){
  try{
    const fertEl = document.getElementById('fertChart'); if(!fertEl) return;
    const ctx = fertEl.getContext('2d');
    const labels = dummyReadings.map(d => d.time);
    const data = dummyReadings.map(d => d.fert);
    fertChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ label:'Estimasi kebutuhan (kg)', data, tension:0.3, fill:true }]},
      options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });

    const distEl = document.getElementById('distChart'); if(!distEl) return;
    const ctx2 = distEl.getContext('2d');
    // initial distribution by kecamatan (field before ' - ')
    const kecMap = {};
    dummyReadings.forEach(r => { const loc=r.field.split(' - ')[0]; kecMap[loc] = (kecMap[loc]||0) + r.fert; });
    distChart = new Chart(ctx2, {
      type:'bar',
      data:{ labels:Object.keys(kecMap), datasets:[{ label:'Distribusi (kg)', data:Object.values(kecMap) }]},
      options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });
  }catch(e){ console.error('initCharts error', e); }
}

function updateCharts(data){
  try{
    if(!fertChart) return;
    // sort by time for better trend (try to parse date)
    const sorted = data.slice().sort((a,b)=> new Date(a.time)-new Date(b.time));
    fertChart.data.labels = sorted.map(r => r.time);
    fertChart.data.datasets[0].data = sorted.map(r => r.fert);
    fertChart.update();

    if(!distChart) return;
    const kecMap = {};
    data.forEach(r => {
      const loc = r.field.split(' - ')[0];
      kecMap[loc] = (kecMap[loc] || 0) + r.fert;
    });
    distChart.data.labels = Object.keys(kecMap);
    distChart.data.datasets[0].data = Object.values(kecMap);
    distChart.update();
  }catch(e){ console.error('updateCharts error', e); }
}

function initMap(){
  try{
    mapInstance = L.map('map').setView([-4.7, 120.0], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18}).addTo(mapInstance);
    // initial markers
    mapMarkers = [];
    dummyReadings.forEach(r => {
      const m = L.marker([r.lat, r.lon]).addTo(mapInstance).bindPopup(`<b>${r.tag}</b><br>${r.field}<br>Pupuk: ${r.fert} kg`);
      mapMarkers.push(m);
    });
  }catch(e){ console.error('initMap error', e); }
}

function updateMap(data){
  try{
    if(!mapInstance) return;
    // remove existing markers
    mapMarkers.forEach(m => { try{ mapInstance.removeLayer(m); }catch(e){} });
    mapMarkers = [];
    data.forEach(r => {
      if(typeof r.lat === 'number' && typeof r.lon === 'number'){
        const m = L.marker([r.lat, r.lon]).addTo(mapInstance).bindPopup(`<b>${r.tag}</b><br>${r.field}<br>Pupuk: ${r.fert} kg`);
        mapMarkers.push(m);
      }
    });
    if(mapMarkers.length>0){
      const latlngs = data.filter(r=>r.lat && r.lon).map(r=>[r.lat, r.lon]);
      const bounds = L.latLngBounds(latlngs);
      mapInstance.fitBounds(bounds, {padding:[40,40]});
    }
  }catch(e){ console.error('updateMap error', e); }
}

/* ---------- KPIs ---------- */
function updateKPIs(){ updateKPIsFiltered(dummyReadings); }
function updateKPIsFiltered(data){
  try{
    const totalFert = data.reduce((s,r)=>s + (Number(r.fert)||0), 0);
    const elF = document.getElementById('kpiFertilizer'); if(elF) elF.innerText = totalFert.toLocaleString();
    const elT = document.getElementById('kpiTags'); if(elT) elT.innerText = data.length;
    const elFld = document.getElementById('kpiFields'); if(elFld) elFld.innerText = new Set(data.map(r=>r.field)).size;
    const elAcc = document.getElementById('kpiAcc'); if(elAcc) elAcc.innerText = '87%';
  }catch(e){ console.error('updateKPIsFiltered error', e); }
}

/* ---------- Filters (safe) ---------- */
function applyFilters(){
  try{
    const commodity = (document.getElementById('commoditySelect')||{}).value || 'all';
    const location = (document.getElementById('locationSelect')||{}).value || 'all';
    const period = (document.getElementById('periodSelect')||{}).value || 'all';

    let data = dummyReadings.slice();

    if(commodity !== 'all') data = data.filter(d => d.commodity === commodity);
    if(location !== 'all') data = data.filter(d => d.field.toLowerCase().includes(location.toLowerCase()));

    const now = new Date(); let startDate = null;
    if(period === 'last30') startDate = new Date(now.getTime() - 30*24*60*60*1000);
    if(period === 'last90') startDate = new Date(now.getTime() - 90*24*60*60*1000);
    if(period === 'last180') startDate = new Date(now.getTime() - 180*24*60*60*1000);
    if(period === 'ytd') startDate = new Date(now.getFullYear(),0,1);

    if(startDate){
      data = data.filter(d => { const t = new Date(d.time); if(isNaN(t)) return false; return t >= startDate && t <= now; });
    }

    // Render results
    renderTable(data);
    updateKPIsFiltered(data);
    updateCharts(data);   // <-- update charts
    updateMap(data);      // <-- update map

    // Filter blockchain table to only show entries whose tag is in filtered data
    const tags = new Set(data.map(d=>d.tag));
    const tbody = document.querySelector('#blockchainTable tbody');
    if(tbody){
      tbody.innerHTML = '';
      const filteredChain = blockchainChain.filter(b => tags.has(b.tag));
      const dataToRender = filteredChain.length > 0 ? filteredChain : blockchainChain;
      dataToRender.forEach(b => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-index', b.index);
        tr.innerHTML = `<td>${b.index}</td><td style="font-family:monospace;word-break:break-all;">${b.hash}</td><td style="font-family:monospace;word-break:break-all;">${b.prevHash}</td><td>${b.tag}</td><td>${b.distributor}</td><td>${b.store}</td><td>${b.time}</td><td class="status">OK</td>`;
        tr.addEventListener('click', ()=> onBlockchainRowClick(b));
        tbody.appendChild(tr);
      });
    }

    console.log('applyFilters completed — rows:', data.length);
  }catch(e){ console.error('applyFilters error', e); alert('Terjadi kesalahan saat applyFilters — cek console.'); }
}

/* ---------- Verify & Regenerate ---------- */
function verifyBlockchain(){
  try{
    if(!blockchainChain || blockchainChain.length === 0){ alert('Blockchain kosong. Klik Regenerate Chain.'); return false; }
    let allOk = true;
    document.querySelectorAll('#blockchainTable tbody tr').forEach(r => r.classList.remove('danger'));
    for(let i=0;i<blockchainChain.length;i++){
      const block = blockchainChain[i];
      const recomputed = sha256(`${block.tag}|${block.distributor}|${block.store}|${block.time}|${block.prevHash}`);
      const row = document.querySelector(`#blockchainTable tbody tr[data-index='${block.index}']`);
      if(recomputed !== block.hash){
        allOk = false;
        if(row) { row.classList.add('danger'); const sc = row.querySelector('.status'); if(sc) sc.innerText='CORRUPT'; }
      } else {
        if(row) { const sc = row.querySelector('.status'); if(sc) sc.innerText='OK'; }
      }
      if(i>0){
        const prev = blockchainChain[i-1];
        if(block.prevHash !== prev.hash){
          allOk = false;
          if(row){ row.classList.add('danger'); const sc = row.querySelector('.status'); if(sc) sc.innerText='LINK-ERR'; }
        }
      }
    }
    if(allOk) alert('Semua block valid.'); else alert('Terdeteksi block bermasalah. Periksa highlight merah.');
    return allOk;
  }catch(e){ console.error('verifyBlockchain error', e); alert('Error saat verify — cek console.'); }
}

function regenerateChainAndRender(){
  try{
    const rnd = Math.floor(Math.random()*dummyReadings.length);
    const sampleTag = dummyReadings[rnd].tag;
    const newIdx = blockchainLog.length + 1;
    blockchainLog.push({tag: sampleTag, distributor:`Distributor Sim ${newIdx}`, store:`Toko Baru ${newIdx}`, time: (new Date()).toISOString().slice(0,19).replace('T',' ')});
    generateBlockchainChain();
    renderBlockchain();
    alert('Blockchain diregenerasi (entri baru ditambahkan).');
  }catch(e){ console.error('regenerate error', e); alert('Gagal meregenerasi. Cek console.'); }
}

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  try{
    // initial
    renderTable(dummyReadings);
    initCharts();
    initMap();
    updateKPIs();

    // blockchain
    generateBlockchainChain();
    renderBlockchain();
  }catch(e){ console.error('init error', e); }

  // wire events
  const appBtn = document.getElementById('applyFilters'); if(appBtn) appBtn.addEventListener('click', applyFilters);
  const expBtn = document.getElementById('exportCsv'); if(expBtn) expBtn.addEventListener('click', ()=>{
    try{
      const header = ['time','tag','commodity','field','fert','status'];
      const rows = dummyReadings.map(r => [r.time, r.tag, r.commodity, r.field, r.fert, r.status]);
      const csv = [header, ...rows].map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'rfid_readings_sample.csv'; a.click(); URL.revokeObjectURL(url);
    }catch(e){ console.error('export error', e); alert('Export gagal.'); }
  });
  const verBtn = document.getElementById('btnVerify'); if(verBtn) verBtn.addEventListener('click', verifyBlockchain);
  const regenBtn = document.getElementById('btnRegenerate'); if(regenBtn) regenBtn.addEventListener('click', regenerateChainAndRender);
  const modalClose = document.getElementById('modalClose'); if(modalClose) modalClose.addEventListener('click', hideModal);

  console.log('Dashboard initialized (no fatal errors expected).');
});
</script>
</body>
</html>
